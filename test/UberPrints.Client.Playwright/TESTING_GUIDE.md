# Playwright Testing Guide

A comprehensive guide to writing and running Playwright tests for UberPrints.

## Quick Start

### Installation
```bash
cd test/UberPrints.Client.Playwright
npm install
npx playwright install
```

### Run Tests
```bash
# Run all tests
npm test

# Run in UI mode (interactive)
npm run test:ui

# Run in headed mode (see browser)
npm run test:headed

# Debug tests
npm run test:debug
```

## Writing Tests

### Basic Test Structure

```typescript
import { test, expect } from '../fixtures/test-fixtures';

test.describe('Feature Name', () => {
  test('should do something', async ({ homePage }) => {
    // Arrange
    await homePage.goto();

    // Act
    await homePage.clickSubmitRequest();

    // Assert
    expect(homePage.urlContains('/request/new')).toBeTruthy();
  });
});
```

### Using Page Objects

Page Objects encapsulate page interactions and element selectors.

```typescript
test('create a print request', async ({ newRequestPage }) => {
  // Navigate to the page
  await newRequestPage.goto();

  // Fill the form using page object methods
  await newRequestPage.fillRequesterName('Test User');
  await newRequestPage.fillModelUrl('https://example.com/model.stl');
  await newRequestPage.selectFilament(0);

  // Submit
  await newRequestPage.submit();
});
```

### Using Test Data Factory

Generate consistent test data:

```typescript
import { TestDataFactory, TestUrls } from '../fixtures/test-data';

test('submit request with generated data', async ({ newRequestPage }) => {
  const testData = TestDataFactory.createPrintRequest({
    requesterName: 'E2E Test User',
    notes: 'Generated by test data factory',
  });

  await newRequestPage.submitRequest(testData);
});
```

### Available Fixtures

The test suite provides these fixtures automatically:

- `page` - Standard Playwright page
- `context` - Browser context
- `browser` - Browser instance
- `homePage` - Home page object
- `newRequestPage` - New request form page object
- `requestsListPage` - Requests list page object
- `filamentsPage` - Filaments page object
- `isMobile` - Boolean indicating mobile viewport

Example:
```typescript
test('multiple pages', async ({ homePage, filamentsPage, newRequestPage }) => {
  await homePage.goto();
  await filamentsPage.goto();
  await newRequestPage.goto();
});
```

## Page Objects Reference

### HomePage

```typescript
// Navigate
await homePage.goto();

// Verify elements
await homePage.verifyHeadingVisible();
await homePage.verifyNavigationLinks(isMobile);
await homePage.verifyCallToActionButtons();
await homePage.verifyGuestMode();

// Interactions
await homePage.clickSubmitRequest();
await homePage.clickViewAllRequests();
await homePage.navigateToNewRequest();
await homePage.navigateToAllRequests();
await homePage.navigateToFilaments();

// Check state
const isLoggedIn = await homePage.isLoggedIn();
```

### NewRequestPage

```typescript
// Navigate
await newRequestPage.goto();

// Form interactions
await newRequestPage.fillRequesterName('User Name');
await newRequestPage.fillModelUrl('https://example.com/model.stl');
await newRequestPage.selectFilament(0); // by index
await newRequestPage.selectFilamentByName('PLA Red'); // by name
await newRequestPage.fillNotes('Optional notes');
await newRequestPage.setDelivery(true);

// Submit (all-in-one)
await newRequestPage.submitRequest({
  requesterName: 'Test User',
  modelUrl: 'https://example.com/model.stl',
  notes: 'Test request',
  requestDelivery: false,
});

// Validation
await newRequestPage.verifyValidationError();
await newRequestPage.verifyFormInteractive();

// Get info
const count = await newRequestPage.getFilamentCount();
```

### RequestsListPage

```typescript
// Navigate
await requestsListPage.goto();

// Verify
await requestsListPage.verifyPageLoaded();
await requestsListPage.verifyMobileLayout();

// Interactions
await requestsListPage.clickRequestByIndex(0);
await requestsListPage.applyFilter();

// Get info
const count = await requestsListPage.getRequestCount();
const status = await requestsListPage.getRequestStatus(0);
const hasRequests = await requestsListPage.hasRequests();
```

### FilamentsPage

```typescript
// Navigate
await filamentsPage.goto();

// Interactions
await filamentsPage.toggleInStockFilter();

// Verify
await filamentsPage.verifyFilamentProperties();
await filamentsPage.verifyMobileLayout();

// Get info
const count = await filamentsPage.getFilamentCount();
const hasFilaments = await filamentsPage.hasFilaments();
const details = await filamentsPage.getFilamentDetails(0);
```

### BasePage (inherited by all page objects)

```typescript
// Navigation
await basePage.goto('/path');
await basePage.waitForNavigation();

// Utilities
await basePage.waitForElement(locator, timeout);
await basePage.verifyNoErrors();
const hasError = await basePage.isErrorPage();
const url = basePage.getUrl();
const contains = basePage.urlContains('/path');
```

## Test Data Factory

### Creating Test Data

```typescript
// Basic request
const request = TestDataFactory.createPrintRequest();

// Customized request
const request = TestDataFactory.createPrintRequest({
  requesterName: 'Custom Name',
  modelUrl: 'https://custom-url.com/model.stl',
  notes: 'Custom notes',
  requestDelivery: true,
});

// Multiple requests
const requests = TestDataFactory.createMultiplePrintRequests(5);

// Invalid data for validation testing
const invalidUrl = TestDataFactory.createInvalidPrintRequest('url');
const invalidName = TestDataFactory.createInvalidPrintRequest('name');

// Delivery request
const deliveryRequest = TestDataFactory.createDeliveryRequest();

// Minimal request (only required fields)
const minimal = TestDataFactory.createMinimalRequest();
```

### Test URLs

```typescript
import { TestUrls } from '../fixtures/test-data';

TestUrls.validStl                 // 'https://www.thingiverse.com/thing:12345'
TestUrls.validThingiverseUrl      // 'https://www.thingiverse.com/thing:67890'
TestUrls.validExampleUrl          // 'https://example.com/model.stl'
TestUrls.invalidUrl               // 'not-a-valid-url'
TestUrls.invalidProtocol          // 'ftp://example.com/model.stl'
```

## API Helpers

For programmatic backend interaction:

```typescript
import { createApiHelpers } from '../utils/api-helpers';

test('use API helpers', async ({ request }) => {
  const api = createApiHelpers(request);

  // Health check
  await api.waitForApi();

  // Get data
  const filaments = await api.getFilaments();
  const inStock = await api.getInStockFilaments();
  const firstFilament = await api.getFirstAvailableFilament();

  // Create request
  const newRequest = await api.createRequest({
    requesterName: 'API Test',
    modelUrl: 'https://example.com/model.stl',
    filamentId: firstFilament.id,
  });

  // Get requests
  const requests = await api.getRequests();
  const request = await api.getRequest(newRequest.id);

  // Track request
  const tracked = await api.trackRequest(token);

  // Guest session
  const session = await api.createGuestSession();
});
```

## Common Patterns

### Test with Setup and Teardown

```typescript
test.describe('Feature with setup', () => {
  test.beforeEach(async ({ newRequestPage }) => {
    await newRequestPage.goto();
  });

  test('first test', async ({ newRequestPage }) => {
    // Page is already loaded
    await newRequestPage.verifyFormInteractive();
  });

  test('second test', async ({ newRequestPage }) => {
    // Page is reloaded for this test
    await newRequestPage.verifyFormInteractive();
  });
});
```

### Conditional Testing

```typescript
test('test optional feature', async ({ filamentsPage }) => {
  await filamentsPage.goto();

  const hasFilter = await filamentsPage.toggleInStockFilter();

  if (hasFilter) {
    // Test the filter functionality
    expect(hasFilter).toBeTruthy();
  } else {
    test.skip(true, 'Filter not available');
  }
});
```

### Mobile-Specific Tests

```typescript
test('mobile test', async ({ newRequestPage, isMobile }) => {
  test.skip(!isMobile, 'Mobile-only test');

  await newRequestPage.goto();
  // Mobile-specific assertions
});
```

### Error Validation

```typescript
test('validate error handling', async ({ newRequestPage }) => {
  await newRequestPage.goto();

  const invalidData = TestDataFactory.createInvalidPrintRequest('url');
  await newRequestPage.fillRequesterName(invalidData.requesterName!);
  await newRequestPage.fillModelUrl(invalidData.modelUrl!);

  await newRequestPage.submit();

  // Verify error is shown
  await newRequestPage.verifyValidationError(/invalid.*url/i);
});
```

### Complete E2E Workflow

```typescript
test('complete workflow', async ({
  homePage,
  filamentsPage,
  newRequestPage,
  requestsListPage,
}) => {
  // Browse filaments
  await filamentsPage.goto();
  await expect(filamentsPage.heading).toBeVisible();

  // Navigate to create request
  await homePage.goto();
  await homePage.navigateToNewRequest();

  // Create request
  const testData = TestDataFactory.createPrintRequest();
  await newRequestPage.submitRequest(testData);

  // View created request
  await requestsListPage.goto();
  const hasRequests = await requestsListPage.hasRequests();
  expect(hasRequests).toBeTruthy();
});
```

## Debugging Tests

### Interactive Mode (Recommended)

```bash
npm run test:ui
```

This opens Playwright's UI mode where you can:
- See all tests
- Run tests individually
- Step through tests
- Inspect DOM
- View screenshots and traces

### Debug Mode

```bash
npm run test:debug
```

Opens tests with Playwright Inspector for step-by-step debugging.

### Screenshots

```typescript
import { takeDebugScreenshot } from './helpers';

test('debug with screenshot', async ({ page }) => {
  await page.goto('/');
  await takeDebugScreenshot(page, 'homepage');
  // Screenshot saved to test-results/
});
```

### Verbose Output

```bash
npx playwright test --debug
npx playwright test --headed
npx playwright test --trace on
```

## Best Practices

### ✅ DO

- Use Page Objects for all page interactions
- Use Test Data Factory for test data
- Use descriptive test names
- Add custom error messages to assertions
- Wait for specific conditions, not arbitrary timeouts
- Clean up test data when possible
- Use fixtures instead of manual setup

### ❌ DON'T

- Don't use `page.waitForTimeout()` (use proper waits)
- Don't hardcode test data in tests
- Don't repeat selector logic
- Don't create dependencies between tests
- Don't test implementation details
- Don't ignore flaky tests (fix them)

## Running Tests in CI

### GitHub Actions Example

```yaml
- name: Install Playwright
  run: |
    cd test/UberPrints.Client.Playwright
    npm ci
    npx playwright install --with-deps

- name: Run Playwright tests
  run: |
    cd test/UberPrints.Client.Playwright
    npm test

- name: Upload test results
  if: always()
  uses: actions/upload-artifact@v3
  with:
    name: playwright-report
    path: test/UberPrints.Client.Playwright/playwright-report/
```

## Troubleshooting

### Tests Fail Locally

1. Ensure backend is running: `http://localhost:5203`
2. Ensure frontend is running: `http://localhost:5173`
3. Check database has test data (run global-setup)
4. Clear browser cache: `npx playwright clean`

### Timeout Errors

- Increase timeout in test: `test.setTimeout(60000)`
- Check if element selector is correct
- Use `test:ui` to inspect

### Flaky Tests

- Remove all `waitForTimeout()` calls
- Use `waitForLoadState()` or element visibility
- Check for race conditions
- Ensure test isolation

## Additional Resources

- [Playwright Documentation](https://playwright.dev)
- [UberPrints Project README](../../README.md)
- [Test Improvements Documentation](./TEST_IMPROVEMENTS.md)
- [Playwright Best Practices](https://playwright.dev/docs/best-practices)
